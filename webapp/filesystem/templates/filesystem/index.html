<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SADTF - Sistema de Archivos Distribuido</title>
    <!-- Tailwind CSS para estilos rápidos y modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Estilos para el scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Animación de pulso para estado online */
        .status-dot {
            height: 10px; width: 10px; border-radius: 50%; display: inline-block;
        }
        .online { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .offline { background-color: #ef4444; }

        /* Estilo para los bloques de memoria */
        .memory-block {
            width: 20px; height: 20px; margin: 2px; border-radius: 3px;
            transition: all 0.2s;
        }
        .memory-block:hover { transform: scale(1.5); z-index: 10; cursor: help; }
        .block-free { background-color: #334155; }
        .block-used { background-color: #3b82f6; border: 1px solid #60a5fa; }
        .block-replica { background-color: #a855f7; border: 1px solid #c084fc; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 h-screen flex flex-col overflow-hidden">

    <!-- HEADER / BARRA SUPERIOR -->
    <header class="bg-slate-800 border-b border-slate-700 h-16 flex items-center justify-between px-6 shadow-lg z-20">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-network-wired text-blue-500 text-2xl"></i>
            <div>
                <h1 class="text-xl font-bold text-white tracking-wide">SADTF <span class="text-xs font-normal text-slate-400">v1.0</span></h1>
                <p class="text-xs text-slate-400 hidden sm:block">Sistema de Archivos Distribuido Tolerante a Fallas</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Selector de IP Coordinador -->
            <div class="hidden md:flex items-center gap-2 bg-slate-700/50 p-1.5 rounded-lg border border-slate-600" title="Dirección IP del Coordinador">
                <label for="coordinatorIp" class="text-xs text-slate-400 font-medium pl-2"><i class="fa-solid fa-satellite-dish mr-1"></i>IP Coord:</label>
                <input type="text" id="coordinatorIp" value="127.0.0.1" placeholder="192.168.X.X" class="w-28 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm text-center text-white focus:outline-none focus:border-blue-500 transition-colors placeholder-slate-500 font-mono">
            </div>

            <!-- Info del Cliente Local -->
            <div class="hidden lg:flex flex-col items-end mr-2 ml-2">
                <span class="text-xs text-slate-400">Estado del Sistema</span>
                <span id="clientIdDisplay" class="font-mono text-sm text-blue-400">Desconectado</span>
            </div>

            <!-- Botón de Actualización -->
            <button id="btnRefresh" onclick="refreshAll()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold transition-all shadow-lg border border-blue-500 shrink-0">
                <i class="fa-solid fa-arrows-rotate"></i>
                <span class="hidden sm:inline">Actualizar</span>
            </button>

            <!-- Botón de Limpieza -->
            <button id="btnCleanup" onclick="cleanupAll()" class="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-semibold transition-all shadow-lg border border-red-500 shrink-0" title="Limpiar todo el sistema (cuidado: es permanente)">
                <i class="fa-solid fa-trash-can"></i>
                <span class="hidden sm:inline">Limpiar</span>
            </button>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- COLUMNA IZQUIERDA: GESTIÓN DE ARCHIVOS -->
        <section class="w-full md:w-1/2 flex flex-col border-r border-slate-700 bg-slate-800/50 p-4">
            
            <!-- Área de Carga -->
            <div class="mb-4 p-6 border-2 border-dashed border-slate-600 rounded-xl bg-slate-800/80 flex flex-col items-center justify-center hover:border-blue-500 transition-colors cursor-pointer group" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" class="hidden" onchange="handleFileUpload(this)">
                <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-500 group-hover:text-blue-400 mb-2 transition-colors"></i>
                <h3 class="font-semibold text-slate-300">Subir Archivo al Sistema Distribuido</h3>
                <p class="text-xs text-slate-500 mt-1">Soporta cualquier tipo de archivo. (Se dividirá en bloques de 1MB)</p>
            </div>

            <!-- Lista de Archivos -->
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-white"><i class="fa-regular fa-folder-open mr-2"></i>Mis Archivos</h2>
                <span id="fileCount" class="text-xs bg-slate-700 px-2 py-1 rounded">0 archivos</span>
            </div>

            <div class="flex-1 overflow-y-auto pr-2 space-y-2" id="fileListContainer">
                <div class="text-center text-slate-500 mt-10 italic">
                    No hay archivos en el sistema. Conéctate para sincronizar.
                </div>
            </div>
        </section>

        <!-- COLUMNA DERECHA: ESTADO DEL SISTEMA Y NODOS -->
        <section class="w-full md:w-1/2 flex flex-col bg-slate-900 p-4">
            
            <!-- Pestañas de Navegación del Panel Derecho -->
            <div class="flex gap-2 mb-4 border-b border-slate-700 pb-2">
                <button onclick="switchTab('nodes')" id="tab-nodes" class="px-4 py-2 rounded-t-lg text-sm font-semibold bg-blue-600 text-white transition-colors">
                    <i class="fa-solid fa-server mr-2"></i>Nodos Conectados
                </button>
                <button onclick="switchTab('blocks')" id="tab-blocks" class="px-4 py-2 rounded-t-lg text-sm font-semibold bg-slate-800 text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-cubes mr-2"></i>Tabla de Bloques
                </button>
                <button onclick="switchTab('logs')" id="tab-logs" class="px-4 py-2 rounded-t-lg text-sm font-semibold bg-slate-800 text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-terminal mr-2"></i>Consola
                </button>
            </div>

            <div class="flex-1 overflow-hidden relative">
                
                <!-- VISTA: NODOS -->
                <div id="view-nodes" class="h-full flex flex-col overflow-y-auto">
                    <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                        <table class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-700 text-slate-200 uppercase font-medium">
                                <tr>
                                    <th class="px-4 py-3">ID Nodo</th>
                                    <th class="px-4 py-3">Dirección IP</th>
                                    <th class="px-4 py-3 text-center">Estado</th>
                                    <th class="px-4 py-3 text-right">Espacio (MB)</th>
                                </tr>
                            </thead>
                            <tbody id="nodesTableBody" class="divide-y divide-slate-700">
                                <tr><td colspan="4" class="text-center text-slate-500 py-4">Cargando nodos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Resumen de Almacenamiento Global -->
                    <div class="mt-4 p-4 bg-slate-800 rounded-lg border border-slate-700">
                        <h3 class="text-white font-semibold mb-2">Almacenamiento Global Distribuido</h3>
                        <div class="w-full bg-slate-700 rounded-full h-4 mb-2 overflow-hidden">
                            <div id="globalStorageBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-slate-400">
                            <span id="usedStorageText">0 MB Usados</span>
                            <span id="totalStorageText">0 MB Totales</span>
                        </div>
                    </div>
                </div>

                <!-- VISTA: TABLA DE BLOQUES (Mapa visual) -->
                <div id="view-blocks" class="h-full hidden overflow-y-auto">
                    <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 h-full">
                        <h3 class="text-white font-semibold mb-4 text-sm">Mapa de Distribución de Bloques (1MB c/u)</h3>
                        <div class="flex gap-4 mb-4 text-xs">
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-slate-600 rounded"></div> Libre</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-blue-500 border border-blue-400 rounded"></div> Original</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-purple-500 border border-purple-400 rounded"></div> Réplica</div>
                        </div>
                        
                        <!-- Grid de bloques -->
                        <div id="blocksGrid" class="flex flex-wrap content-start h-full pb-10">
                            <!-- Bloques generados dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- VISTA: LOGS / CONSOLA -->
                <div id="view-logs" class="h-full hidden flex-col bg-black rounded-lg border border-slate-700 p-4 font-mono text-xs overflow-y-auto text-green-400 shadow-inner">
                    <p>[SYSTEM] Interfaz inicializada. Conectando al coordinador...</p>
                </div>

            </div>
        </section>
    </main>

    <!-- MODAL DE PREVISUALIZACIÓN -->
    <div id="previewModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl shadow-2xl max-w-4xl w-full border border-slate-600 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b border-slate-700">
                <h3 id="modalTitle" class="text-white font-semibold text-lg">Visualizar Archivo</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 flex-1 overflow-auto flex items-center justify-center bg-slate-900/50" id="modalContent">
                <!-- Contenido dinámico (img/video/info) -->
            </div>
            <!-- Tabla de atributos del archivo específico -->
            <div class="p-4 bg-slate-900 border-t border-slate-700">
                <h4 class="text-xs font-bold uppercase text-slate-500 mb-2">Atributos de distribución (Bloques)</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left text-slate-300">
                        <thead class="text-slate-500">
                            <tr><th>Bloque #</th><th>Ubicación (Nodo)</th><th>Réplica (Nodo)</th><th>Estado</th></tr>
                        </thead>
                        <tbody id="fileAttributesTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO DE LA APLICACIÓN ---
        let systemFiles = [];
        let nodesData = [];
        let blockTableData = null;
        let refreshInterval = null;
        let lastEventTimestamp = 0;  // Para monitoreo de eventos
        let needsRefresh = false;    // Bandera para actualizar tabla de nodos

        // --- FUNCIONES DE INICIALIZACIÓN ---
        function init() {
            // Cargar IP del coordinador desde el archivo de configuración
            fetch('/api/get-coordinator-host/')
                .then(response => response.json())
                .then(data => {
                    if (data.coordinator_host) {
                        const ipInput = document.getElementById('coordinatorIp');
                        if (ipInput) {
                            ipInput.value = data.coordinator_host;
                        }
                    }
                    log("Interfaz inicializada. Conectando al coordinador...");
                    refreshAll();
                    // Actualizar automáticamente cada 5 segundos
                    refreshInterval = setInterval(refreshAll, 5000);
                })
                .catch(() => {
                    log("Interfaz inicializada. Conectando al coordinador...");
                    refreshAll();
                    refreshInterval = setInterval(refreshAll, 5000);
                });
        }

        // --- FUNCIONES DE API ---
        function getCoordinatorHost() {
            const ipInput = document.getElementById('coordinatorIp');
            return ipInput ? ipInput.value.trim() || '127.0.0.1' : '127.0.0.1';
        }

        async function fetchNodes() {
            try {
                const coordinatorHost = getCoordinatorHost();
                const response = await fetch(`/api/nodes/?coordinator_host=${encodeURIComponent(coordinatorHost)}`);
                const data = await response.json();
                if (data.nodes) {
                    nodesData = data.nodes;
                    renderNodes();
                    document.getElementById('clientIdDisplay').textContent = nodesData.length > 0 ? 'Conectado' : 'Desconectado';
                    document.getElementById('clientIdDisplay').className = nodesData.length > 0 ? 'font-mono text-sm text-green-400' : 'font-mono text-sm text-blue-400';
                }
            } catch (error) {
                log('Error obteniendo nodos: ' + error.message);
            }
        }

        async function fetchFiles() {
            try {
                const coordinatorHost = getCoordinatorHost();
                const response = await fetch(`/api/files/?coordinator_host=${encodeURIComponent(coordinatorHost)}`);
                const data = await response.json();
                if (data.files) {
                    systemFiles = data.files;
                    renderFiles();
                }
            } catch (error) {
                log('Error obteniendo archivos: ' + error.message);
            }
        }

        async function fetchBlockTable() {
            try {
                const coordinatorHost = getCoordinatorHost();
                const response = await fetch(`/api/blocks/?coordinator_host=${encodeURIComponent(coordinatorHost)}`);
                const data = await response.json();
                if (data.table) {
                    blockTableData = data.table;
                    renderBlocksMap();
                }
            } catch (error) {
                log('Error obteniendo tabla de bloques: ' + error.message);
            }
        }

        async function checkRecentEvents() {
            """Verifica si hay eventos recientes (desconexiones de nodos, etc)"""
            try {
                const response = await fetch('/api/events/?since=' + (lastEventTimestamp || 0));
                const data = await response.json();
                
                if (data.events && data.events.length > 0) {
                    // Procesar eventos
                    for (const event of data.events) {
                        if (event.type === 'NODE_DISCONNECTED') {
                            console.log(`[!] Nodo desconectado: ${event.data.node_id}`);
                            // Marcar que necesitamos recargar nodos
                            needsRefresh = true;
                        }
                    }
                    
                    // Si hubo eventos importantes, actualizar la tabla
                    if (needsRefresh) {
                        await fetchNodes();
                        needsRefresh = false;
                    }
                    
                    lastEventTimestamp = data.timestamp;
                }
            } catch (error) {
                // Silenciar errores de eventos
            }
        }

        async function refreshAll() {
            await Promise.all([fetchNodes(), fetchFiles(), fetchBlockTable()]);
            // Verificar eventos también
            await checkRecentEvents();
        }

        // --- RENDERIZADO DE UI ---
        function renderNodes() {
            const tbody = document.getElementById('nodesTableBody');
            tbody.innerHTML = '';
            
            let totalCap = 0;
            let totalUsed = 0;

            if (nodesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 py-4">No hay nodos conectados</td></tr>';
                return;
            }

            // Calcular uso real desde blockTableData
            const nodeBlockUsage = {};
            if (blockTableData && blockTableData.blocks) {
                blockTableData.blocks.forEach(block => {
                    if (block.status !== 'FREE' && block.primary_node_id) {
                        if (!nodeBlockUsage[block.primary_node_id]) {
                            nodeBlockUsage[block.primary_node_id] = 0;
                        }
                        nodeBlockUsage[block.primary_node_id]++;
                    }
                });
            }

            nodesData.forEach(node => {
                if (node.is_alive) {
                    const capacityMB = Math.round(node.shared_space_size / (1024 * 1024));
                    totalCap += capacityMB;
                    // Uso real: cantidad de bloques usados en este nodo (cada bloque = 1MB)
                    const usedMB = nodeBlockUsage[node.node_id] || 0;
                    totalUsed += usedMB;
                }

                const row = `
                    <tr class="hover:bg-slate-800 transition-colors border-b border-slate-700/50">
                        <td class="px-4 py-3 font-mono text-blue-300">${node.node_id}</td>
                        <td class="px-4 py-3 text-slate-500">${node.address}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs font-medium ${node.is_alive ? 'bg-green-900 text-green-300 border border-green-700' : 'bg-red-900 text-red-300 border border-red-700'}">
                                <span class="status-dot ${node.is_alive ? 'online' : 'offline'}"></span>
                                ${node.is_alive ? 'ONLINE' : 'OFFLINE'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right font-mono">
                            ${node.is_alive ? Math.round(node.shared_space_size / (1024 * 1024)) + ' MB' : '-'}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            updateStorageBar(totalUsed, totalCap);
        }

        function updateStorageBar(used, total) {
            const percentage = total > 0 ? (used / total) * 100 : 0;
            document.getElementById('globalStorageBar').style.width = `${percentage}%`;
            document.getElementById('usedStorageText').innerText = `${used} MB Usados`;
            document.getElementById('totalStorageText').innerText = `${total} MB Totales`;
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function renderFiles() {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = '';
            document.getElementById('fileCount').innerText = `${systemFiles.length} archivos`;

            if (systemFiles.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 mt-10 italic">No hay archivos en el sistema.</div>';
                return;
            }

            systemFiles.forEach((file, index) => {
                let iconClass = "fa-file";
                let colorClass = "text-slate-400";
                
                const filename = file.filename || file.file_id;
                const ext = filename.split('.').pop().toLowerCase();
                
                if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) { 
                    iconClass = "fa-file-image"; 
                    colorClass = "text-purple-400"; 
                } else if (['mp4', 'avi', 'mov', 'webm'].includes(ext)) { 
                    iconClass = "fa-file-video"; 
                    colorClass = "text-red-400"; 
                } else if (['pdf'].includes(ext)) { 
                    iconClass = "fa-file-pdf"; 
                    colorClass = "text-orange-400"; 
                }

                const html = `
                    <div class="glass-panel p-3 rounded-lg flex items-center justify-between group hover:bg-slate-700 transition-all">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded bg-slate-800 flex items-center justify-center shrink-0">
                                <i class="fa-regular ${iconClass} ${colorClass} text-xl"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-medium text-slate-200 truncate pr-2">${filename}</h4>
                                <div class="flex gap-3 text-xs text-slate-500">
                                    <span>${formatSize(file.size)}</span>
                                    <span>${file.upload_date ? new Date(file.upload_date).toLocaleDateString() : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                            <button onclick="viewFile('${file.file_id}')" title="Ver / Atributos" class="p-2 hover:bg-blue-600 rounded text-slate-300 hover:text-white transition-colors"><i class="fa-solid fa-eye"></i></button>
                            <button onclick="downloadFile('${file.file_id}', '${filename}')" title="Descargar" class="p-2 hover:bg-green-600 rounded text-slate-300 hover:text-white transition-colors"><i class="fa-solid fa-download"></i></button>
                            <button onclick="deleteFile('${file.file_id}', '${filename}')" title="Eliminar" class="p-2 hover:bg-red-600 rounded text-slate-300 hover:text-white transition-colors"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function renderBlocksMap() {
            const grid = document.getElementById('blocksGrid');
            grid.innerHTML = '';

            if (!blockTableData || !blockTableData.blocks) {
                grid.innerHTML = '<div class="text-slate-500 text-center w-full">No hay datos de bloques disponibles</div>';
                return;
            }

            const blocks = blockTableData.blocks;
            
            // Ordenar bloques por ID (nodo1001, nodo1002, nodo2001, etc.)
            const sortedBlocks = blocks.sort((a, b) => {
                // Extraer número del nodo y número de bloque
                const getBlockNum = (blockId) => {
                    const match = blockId.match(/nodo(\d+)(\d+)/);
                    if (match) {
                        return parseInt(match[1]) * 10000 + parseInt(match[2]);
                    }
                    return 0;
                };
                return getBlockNum(a.block_id) - getBlockNum(b.block_id);
            });

            // Mostrar todos los bloques
            sortedBlocks.forEach(block => {
                const div = document.createElement('div');
                div.className = 'memory-block';
                
                let title = `ID: ${block.block_id}`;
                const primaryNode = block.primary_node_id || block.node_id || 'N/A';
                title += `\nNodo Primario: ${primaryNode}`;
                
                if (block.status === 'FREE') {
                    div.classList.add('block-free');
                    title += "\nEstado: Libre";
                } else if (block.status === 'REPLICATED' || block.status === 'USED') {
                    div.classList.add('block-used');
                    title += `\nEstado: Ocupado (Original)`;
                    title += `\nArchivo: ${block.file_id || 'N/A'}`;
                    if (block.replica_node_id) {
                        title += `\nRéplica en: ${block.replica_node_id}`;
                    }
                } else {
                    div.classList.add('block-replica');
                    title += "\nEstado: Réplica";
                }
                
                div.title = title;
                grid.appendChild(div);
            });
        }

        // --- INTERACCIONES DE ARCHIVOS ---
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            log(`Iniciando subida: ${file.name} (${formatSize(file.size)})`);
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                log(`> Dividiendo en bloques de 1MB...`);
                const coordinatorHost = getCoordinatorHost();
                formData.append('coordinator_host', coordinatorHost);
                const response = await fetch('/api/files/upload/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    log(`Archivo guardado exitosamente: ${file.name}`);
                    await refreshAll();
                } else {
                    log(`Error: ${data.error}`);
                    alert('Error subiendo archivo: ' + data.error);
                }
            } catch (error) {
                log(`Error subiendo archivo: ${error.message}`);
                alert('Error subiendo archivo: ' + error.message);
            }
        }

        async function deleteFile(fileId, filename) {
            if(!confirm(`¿Eliminar archivo "${filename}" y liberar sus bloques en todos los nodos?`)) {
                return;
            }

            log(`Solicitando eliminación de ${filename}...`);
            
            try {
                const coordinatorHost = getCoordinatorHost();
                const response = await fetch('/api/files/delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ file_id: fileId, coordinator_host: coordinatorHost })
                });

                const data = await response.json();
                if (data.success) {
                    log(`> Marcando entradas de tabla de bloques como LIBRES.`);
                    log(`> Eliminando réplicas en nodos...`);
                    log(`Archivo eliminado: ${filename}`);
                    await refreshAll();
                } else {
                    log(`Error: ${data.error}`);
                    alert('Error eliminando archivo: ' + data.error);
                }
            } catch (error) {
                log(`Error eliminando archivo: ${error.message}`);
                alert('Error eliminando archivo: ' + error.message);
            }
        }

        function downloadFile(fileId, filename) {
            log(`Descargando ${filename}... Recopilando bloques de nodos disponibles.`);
            const coordinatorHost = getCoordinatorHost();
            window.location.href = `/api/files/download/?file_id=${fileId}&coordinator_host=${encodeURIComponent(coordinatorHost)}`;
            log(`Descarga iniciada: ${filename}`);
        }

        async function viewFile(fileId) {
            try {
                const coordinatorHost = getCoordinatorHost();
                const response = await fetch(`/api/files/info/?file_id=${encodeURIComponent(fileId)}&coordinator_host=${encodeURIComponent(coordinatorHost)}`);
                const data = await response.json();
                
                if (data.file && data.blocks) {
                    const file = data.file;
                    const modal = document.getElementById('previewModal');
                    const content = document.getElementById('modalContent');
                    const tableBody = document.getElementById('fileAttributesTable');
                    
                    document.getElementById('modalTitle').innerText = file.filename;

                    // Mostrar información del archivo
                    content.innerHTML = `
                        <div class="text-center w-full">
                            <i class="fa-solid fa-file-lines text-6xl text-slate-500 mb-4"></i>
                            <p class="text-slate-300 mb-2"><strong>Nombre:</strong> ${file.filename}</p>
                            <p class="text-slate-300 mb-2"><strong>Tamaño:</strong> ${formatSize(file.size)}</p>
                            <p class="text-slate-300 mb-2"><strong>Bloques:</strong> ${file.num_blocks}</p>
                            <p class="text-slate-300"><strong>Fecha:</strong> ${new Date(file.upload_date).toLocaleString()}</p>
                        </div>
                    `;

                    // Llenar tabla de atributos
                    tableBody.innerHTML = '';
                    data.blocks.forEach(block => {
                        const row = `
                            <tr class="border-b border-slate-800">
                                <td class="py-2 px-2 text-blue-400">Bloque #${block.block_number}</td>
                                <td class="py-2 px-2 font-mono text-slate-300">${block.node_id}</td>
                                <td class="py-2 px-2 font-mono text-slate-300">${block.replica_node_id || 'N/A'}</td>
                                <td class="py-2 px-2"><span class="text-xs px-1 rounded bg-green-900 text-green-300">${block.status}</span></td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });

                    modal.classList.remove('hidden');
                } else {
                    alert('Error obteniendo información del archivo');
                }
            } catch (error) {
                log(`Error obteniendo información: ${error.message}`);
                alert('Error obteniendo información del archivo: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        // --- UTILIDADES ---
        function switchTab(tabName) {
            // Ocultar todas
            document.getElementById('view-nodes').classList.add('hidden');
            document.getElementById('view-blocks').classList.add('hidden');
            document.getElementById('view-logs').classList.remove('flex');
            document.getElementById('view-logs').classList.add('hidden');

            // Reset botones
            ['nodes', 'blocks', 'logs'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                btn.classList.replace('bg-blue-600', 'bg-slate-800');
                btn.classList.replace('text-white', 'text-slate-400');
            });

            // Mostrar activa
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.replace('bg-slate-800', 'bg-blue-600');
            activeBtn.classList.replace('text-slate-400', 'text-white');

            if (tabName === 'logs') {
                document.getElementById(`view-${tabName}`).classList.remove('hidden');
                document.getElementById(`view-${tabName}`).classList.add('flex');
            } else {
                document.getElementById(`view-${tabName}`).classList.remove('hidden');
            }
        }

        function log(msg) {
            const consoleDiv = document.getElementById('view-logs');
            const time = new Date().toLocaleTimeString();
            const p = document.createElement('p');
            p.innerHTML = `<span class="text-slate-500">[${time}]</span> ${msg}`;
            consoleDiv.appendChild(p);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // Función para limpiar todo el sistema
        async function cleanupAll() {
            // Confirmar operación
            const confirmed = confirm(
                '⚠️  ADVERTENCIA: Esto eliminará TODOS los archivos y bloques del sistema.\n\n' +
                'Esta operación es PERMANENTE y no se puede deshacer.\n\n' +
                '¿Está seguro de que desea continuar?'
            );

            if (!confirmed) {
                log('[LIMPIEZA] Operación cancelada por el usuario');
                return;
            }

            // Segunda confirmación
            const doubleConfirm = confirm('¿Realmente está seguro? Escriba SÍ si desea continuar.\n(Solo puede hacer clic en OK para confirmar)');
            if (!doubleConfirm) {
                log('[LIMPIEZA] Operación cancelada');
                return;
            }

            log('[LIMPIEZA] Iniciando limpieza completa del sistema...');
            const btnCleanup = document.getElementById('btnCleanup');
            btnCleanup.disabled = true;
            btnCleanup.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const coordinatorHost = getCoordinatorHost();
                log(`[LIMPIEZA] Conectando al coordinador en ${coordinatorHost}...`);
                
                const response = await fetch(`/api/cleanup/?coordinator_host=${encodeURIComponent(coordinatorHost)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    log('[✓ LIMPIEZA] Sistema limpiado exitosamente');
                    log(`[✓ LIMPIEZA] Archivos eliminados: ${data.details.files_deleted}`);
                    log(`[✓ LIMPIEZA] Nodos desconectados: ${data.details.nodes_disconnected}`);
                    log('[✓ LIMPIEZA] Tabla de bloques limpiada');
                    log('[✓ LIMPIEZA] Sistema listo para comenzar de cero');
                    
                    // Esperar 2 segundos y refrescar la interfaz
                    setTimeout(() => {
                        log('[LIMPIEZA] Refrescando interfaz...');
                        refreshAll();
                    }, 2000);
                } else {
                    const errorMsg = data.error || 'Error desconocido';
                    log(`[✗ LIMPIEZA] Error: ${errorMsg}`);
                    alert('Error durante la limpieza: ' + errorMsg);
                }
            } catch (error) {
                log(`[✗ LIMPIEZA] Error de conexión: ${error.message}`);
                alert('Error al conectar con el coordinador: ' + error.message);
            } finally {
                btnCleanup.disabled = false;
                btnCleanup.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Iniciar
        init();
    </script>
</body>
</html>
